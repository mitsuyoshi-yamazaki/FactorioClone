# ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨æ¤œè¨

## æ¦‚è¦

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€Factorioã‚¯ãƒ­ãƒ¼ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é©ç”¨å¯èƒ½ãªãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¤ã„ã¦èª¿æŸ»ãƒ»æ¤œè¨ã—ãŸçµæœã‚’ã¾ã¨ã‚ã‚‹ã€‚

## æ¨å¥¨ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³

### 1. Entity Component System (ECS) â­ï¸æœ€é‡è¦

#### è©³ç´°èª¬æ˜

ECSï¼ˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ»ã‚·ã‚¹ãƒ†ãƒ ï¼‰ã¯ä¸»ã«ã‚²ãƒ¼ãƒ é–‹ç™ºã§ä½¿ç”¨ã•ã‚Œã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã‚ã‚‹ã€‚å¾“æ¥ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘ã®ç¶™æ‰¿ã‚ˆã‚Šã‚‚ã€ã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ã®åŸå‰‡ã«å¾“ã†ã“ã¨ã§ã€ã‚ˆã‚ŠæŸ”è»Ÿã«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹ã€‚

**åŸºæœ¬æ§‹æˆè¦ç´ **ï¼š
- **Entityï¼ˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰**: æ±ç”¨çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ã—ã€é€šå¸¸ã¯ä¸€æ„ã®IDã®ã¿ã§æ§‹æˆã•ã‚Œã‚‹
- **Componentï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰**: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒç‰¹å®šã®å´é¢ã‚’æŒã¤ã“ã¨ã‚’ç‰¹å¾´ä»˜ã‘ã€ãã®å´é¢ã‚’ãƒ¢ãƒ‡ãƒ«åŒ–ã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹
- **Systemï¼ˆã‚·ã‚¹ãƒ†ãƒ ï¼‰**: å„ã‚·ã‚¹ãƒ†ãƒ ã¯ã‚²ãƒ¼ãƒ ã®ç‰¹å®šã®å´é¢ã®ãƒ­ã‚¸ãƒƒã‚¯ã¨æŒ¯ã‚‹èˆã„ã‚’åˆ¶å¾¡ã™ã‚‹

#### Factorioã‚¯ãƒ­ãƒ¼ãƒ³ã§ã®é©ç”¨

**Entityä¾‹**:
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
- ãƒ™ãƒ«ãƒˆã‚³ãƒ³ãƒ™ã‚¢
- ã‚¤ãƒ³ã‚µãƒ¼ã‚¿
- çµ„ç«‹æ©Ÿ
- è³‡æºãƒãƒ¼ãƒ‰

**Componentä¾‹**:
```typescript
interface Position { x: number; y: number; }
interface Renderable { type: string; color: string; }
interface Inventory { items: Map<string, number>; capacity: number; }
interface Recipe { input: Item[]; output: Item[]; duration: number; }
interface PowerConsumer { consumption: number; }
interface ItemTransporter { direction: Direction; speed: number; }
```

**Systemä¾‹**:
- MovementSystem: Position componentã‚’æŒã¤ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç§»å‹•å‡¦ç†
- RenderSystem: Position + Renderable componentã‚’æŒã¤ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®æç”»
- CraftingSystem: Recipe + Inventory componentã‚’æŒã¤ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®è£½é€ å‡¦ç†
- PowerSystem: PowerConsumer componentã‚’æŒã¤ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®é›»åŠ›ç®¡ç†
- TransportSystem: ItemTransporter componentã‚’æŒã¤ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ã‚¢ã‚¤ãƒ†ãƒ è¼¸é€

#### å®Ÿè£…ä¾‹

```typescript
class Entity {
  private components = new Map<string, any>();

  addComponent<T>(component: T): this {
    this.components.set(component.constructor.name, component);
    return this;
  }

  getComponent<T>(type: new() => T): T | undefined {
    return this.components.get(type.name);
  }
}

// ä½¿ç”¨ä¾‹
const belt = new Entity()
  .addComponent(new Position(100, 100))
  .addComponent(new Renderable('rect', 'yellow'))
  .addComponent(new ItemTransporter(Direction.Right, 2))
  .addComponent(new PowerConsumer(1));
```

#### å‚è€ƒè¨˜äº‹
- [ECS (Entity Component System)ã«ã¤ã„ã¦ - Zenn](https://zenn.dev/suuta/articles/0aa567690ec52a) ï¼ˆæ—¥æœ¬èªï¼‰
- [Unity ã§ã®ã‚²ãƒ¼ãƒ é–‹ç™ºã§ ECS ã®æ€æƒ³ã‚’å–ã‚Šå…¥ã‚ŒãŸè©±](https://guinpen98.github.io/VuePress/articles/OperationR-ECS.html) ï¼ˆæ—¥æœ¬èªï¼‰
- [ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ»ã‚·ã‚¹ãƒ†ãƒ  - Wikipedia](https://ja.wikipedia.org/wiki/ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ»ã‚·ã‚¹ãƒ†ãƒ ) ï¼ˆæ—¥æœ¬èªï¼‰
- [The Entity-Component-System pattern | JavaScript for Games](https://jsforgames.com/ecs/) ï¼ˆè‹±èªï¼‰
- [Building a tiny type-safe typescript ECS - DEV Community](https://dev.to/trymnilsen/building-a-tiny-type-safe-typescript-ecs-entity-component-system-dil) ï¼ˆè‹±èªï¼‰

### 2. State Pattern â­ï¸é‡è¦

#### è©³ç´°èª¬æ˜

ã‚¹ãƒ†ãƒ¼ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å†…éƒ¨çŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸæ™‚ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æŒ¯ã‚‹èˆã„ã‚’å¤‰æ›´ã™ã‚‹è¡Œå‹•ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã‚ã‚‹ã€‚æœ‰é™çŠ¶æ…‹æ©Ÿæ¢°ï¼ˆFSMï¼‰ã®æ¦‚å¿µã¨å¯†æ¥ã«é–¢é€£ã—ã¦ã„ã‚‹ã€‚

ã‚²ãƒ¼ãƒ é–‹ç™ºã«ãŠã„ã¦ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚„æ©Ÿæ¢°ã®è¤‡é›‘ãªçŠ¶æ…‹é·ç§»ã‚’ç®¡ç†ã™ã‚‹ã®ã«éå¸¸ã«æœ‰åŠ¹ã§ã‚ã‚‹ã€‚çŠ¶æ…‹ã”ã¨ã«ç•°ãªã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã€çŠ¶æ…‹ã«å¿œã˜ãŸæŒ¯ã‚‹èˆã„ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–ã§ãã‚‹ã€‚

#### Factorioã‚¯ãƒ­ãƒ¼ãƒ³ã§ã®é©ç”¨

**çµ„ç«‹æ©Ÿã®çŠ¶æ…‹ç®¡ç†**:
```typescript
interface AssemblerState {
  handle(assembler: Assembler): void;
  canCraft(): boolean;
}

class AssemblerIdleState implements AssemblerState {
  handle(assembler: Assembler) {
    if (assembler.hasRecipe() && assembler.hasPower() && assembler.hasInputs()) {
      assembler.setState(new AssemblerCraftingState());
    }
  }
  canCraft() { return false; }
}

class AssemblerCraftingState implements AssemblerState {
  private progress = 0;

  handle(assembler: Assembler) {
    if (!assembler.hasPower()) {
      assembler.setState(new AssemblerNoPowerState());
      return;
    }

    this.progress += assembler.getCraftingSpeed();
    if (this.progress >= assembler.getRecipe().duration) {
      assembler.produceItems();
      assembler.setState(new AssemblerIdleState());
    }
  }
  canCraft() { return true; }
}
```

**ã‚¤ãƒ³ã‚µãƒ¼ã‚¿ã®çŠ¶æ…‹ç®¡ç†**:
- WaitingState: ã‚¢ã‚¤ãƒ†ãƒ ã®å‡ºç¾ã‚’å¾…æ©Ÿ
- GrabbingState: ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ´ã‚€
- MovingState: ã‚¢ã‚¤ãƒ†ãƒ ã‚’é‹ã¶
- InsertingState: ã‚¢ã‚¤ãƒ†ãƒ ã‚’é…ç½®

**ã‚²ãƒ¼ãƒ å…¨ä½“ã®çŠ¶æ…‹ç®¡ç†**:
- PlayingState: ã‚²ãƒ¼ãƒ ä¸­
- PausedState: ä¸€æ™‚åœæ­¢
- MenuState: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢
- InventoryState: ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªç”»é¢

#### å‚è€ƒè¨˜äº‹
- [ã€TSã€‘ä»Šã•ã‚‰èã‘ãªã„ã‚¹ãƒ†ãƒ¼ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ - Zenn](https://zenn.dev/nekoniki/articles/b039e5e553b5e95729b5) ï¼ˆæ—¥æœ¬èªï¼‰
- [State - Refactoring Guru](https://refactoring.guru/ja/design-patterns/state) ï¼ˆæ—¥æœ¬èªï¼‰
- [ã‚¹ãƒ†ãƒ¼ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆState Patternï¼‰ï½œUnity - level up your code](https://zenn.dev/twugo/books/21cb3a6515e7b8/viewer/b48713) ï¼ˆæ—¥æœ¬èªï¼‰
- [ğŸ“– ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã¨çŠ¶æ…‹é·ç§»å›³ã«ã¤ã„ã¦ï½œXStateã®è§£èª¬](https://zenn.dev/susiyaki/books/379ad159248627/viewer/what-is-state-machines-and-statecharts) ï¼ˆæ—¥æœ¬èªï¼‰
- [State in TypeScript / Design Patterns](https://refactoring.guru/design-patterns/state/typescript/example) ï¼ˆè‹±èªï¼‰

### 3. Observer Pattern â­ï¸é‡è¦

#### è©³ç´°èª¬æ˜

ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé–“ã®1å¯¾å¤šã®ä¾å­˜é–¢ä¿‚ã‚’å®šç¾©ã™ã‚‹è¡Œå‹•ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã‚ã‚‹ã€‚ã‚ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆSubjectï¼‰ã®çŠ¶æ…‹ãŒå¤‰åŒ–ã—ãŸæ™‚ã«ã€ãã‚Œã«ä¾å­˜ã™ã‚‹è¤‡æ•°ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆObserverï¼‰ã«è‡ªå‹•çš„ã«é€šçŸ¥ã•ã‚Œã‚‹ä»•çµ„ã¿ã‚’æä¾›ã™ã‚‹ã€‚

ã‚²ãƒ¼ãƒ é–‹ç™ºã§ã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã€pub-subãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã«ç‰¹ã«æœ‰ç”¨ã§ã€ã‚·ã‚¹ãƒ†ãƒ é–“ã®ç–çµåˆã‚’å®Ÿç¾ã—ã€ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼ã§é©å¿œå¯èƒ½ãªã‚·ã‚¹ãƒ†ãƒ ã‚’ä½œã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

#### Factorioã‚¯ãƒ­ãƒ¼ãƒ³ã§ã®é©ç”¨

**é›»åŠ›ã‚°ãƒªãƒƒãƒ‰é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ **:
```typescript
interface PowerObserver {
  onPowerChange(supply: number, demand: number): void;
}

class PowerGrid {
  private observers: PowerObserver[] = [];
  private supply = 0;
  private demand = 0;

  addObserver(observer: PowerObserver) {
    this.observers.push(observer);
  }

  removeObserver(observer: PowerObserver) {
    this.observers = this.observers.filter(obs => obs !== observer);
  }

  notifyPowerChange() {
    this.observers.forEach(obs => obs.onPowerChange(this.supply, this.demand));
  }

  updatePower(newSupply: number, newDemand: number) {
    this.supply = newSupply;
    this.demand = newDemand;
    this.notifyPowerChange();
  }
}

// æ©Ÿæ¢°ãŒé›»åŠ›å¤‰åŒ–ã‚’ç›£è¦–
class Assembler implements PowerObserver {
  onPowerChange(supply: number, demand: number) {
    if (supply < demand) {
      this.setState(new AssemblerNoPowerState());
    }
  }
}
```

**EventBusãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…**:
```typescript
class EventBus {
  private events = new Map<string, Function[]>();

  on(event: string, callback: Function) {
    if (!this.events.has(event)) {
      this.events.set(event, []);
    }
    this.events.get(event)!.push(callback);
  }

  emit(event: string, ...args: any[]) {
    if (this.events.has(event)) {
      this.events.get(event)!.forEach(callback => callback(...args));
    }
  }

  off(event: string, callback: Function) {
    if (this.events.has(event)) {
      this.events.set(event,
        this.events.get(event)!.filter(cb => cb !== callback)
      );
    }
  }
}

// ä½¿ç”¨ä¾‹
const eventBus = new EventBus();

// ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªå¤‰æ›´ã®é€šçŸ¥
eventBus.on('inventory-changed', (items) => {
  updateInventoryUI(items);
});

// ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿç”£ã®é€šçŸ¥
eventBus.on('item-produced', (item, quantity) => {
  updateStatistics(item, quantity);
});
```

#### é©ç”¨å ´é¢
- é›»åŠ›ã‚°ãƒªãƒƒãƒ‰ã®ä¾›çµ¦/éœ€è¦å¤‰å‹•é€šçŸ¥
- ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªå¤‰æ›´ã®UIæ›´æ–°é€šçŸ¥
- ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿç”£ã®çµ±è¨ˆæ›´æ–°é€šçŸ¥
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ­ã‚°è¨˜éŒ²
- å®Ÿç¸¾ã‚·ã‚¹ãƒ†ãƒ ã®é€²æ—è¿½è·¡

#### å‚è€ƒè¨˜äº‹
- [TypeScript ã§å­¦ã¶ Observer ãƒ‘ã‚¿ãƒ¼ãƒ³ | Recruit Tech Blog](https://techblog.recruit.co.jp/article-484/) ï¼ˆæ—¥æœ¬èªï¼‰
- [ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ‘ã‚¿ãƒ¼ãƒ³å®Œå…¨ã«ç†è§£ã—ãŸï½œerukiti](https://note.com/erukiti/n/n1d6e0fcfaefc) ï¼ˆæ—¥æœ¬èªï¼‰
- [Observer - Refactoring Guru](https://refactoring.guru/ja/design-patterns/observer) ï¼ˆæ—¥æœ¬èªï¼‰
- [Observer ãƒ‘ã‚¿ãƒ¼ãƒ³ - Wikipedia](https://ja.wikipedia.org/wiki/Observer_ãƒ‘ã‚¿ãƒ¼ãƒ³) ï¼ˆæ—¥æœ¬èªï¼‰
- [Let's Create a Lightweight Native Event Bus in JavaScript](https://css-tricks.com/lets-create-a-lightweight-native-event-bus-in-javascript/) ï¼ˆè‹±èªï¼‰

### 4. Factory Pattern ã€‡é©ç”¨å¯èƒ½

#### è©³ç´°èª¬æ˜

ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰éš è”½ã—ã€å…±é€šã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’é€šã˜ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ç”Ÿæˆãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã‚ã‚‹ã€‚ç‰¹ã«ã€æ§˜ã€…ãªç¨®é¡ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆæ•µã€ã‚¢ã‚¤ãƒ†ãƒ ã€è¨­å‚™ãªã©ï¼‰ã‚’å…±é€šã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ä½œæˆã™ã‚‹å ´åˆã«æœ‰ç”¨ã§ã‚ã‚‹ã€‚

#### Factorioã‚¯ãƒ­ãƒ¼ãƒ³ã§ã®é©ç”¨

**ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãƒª**:
```typescript
abstract class EntityFactory {
  abstract createEntity(x: number, y: number): Entity;
}

class BeltFactory extends EntityFactory {
  createEntity(x: number, y: number, direction: Direction): Entity {
    return new Entity()
      .addComponent(new Position(x, y))
      .addComponent(new Renderable('rect', 'yellow'))
      .addComponent(new ItemTransporter(direction, 2))
      .addComponent(new PowerConsumer(1));
  }
}

class InserterFactory extends EntityFactory {
  createEntity(x: number, y: number, rotation: number): Entity {
    return new Entity()
      .addComponent(new Position(x, y))
      .addComponent(new Renderable('circle', 'orange'))
      .addComponent(new InserterArm(rotation))
      .addComponent(new PowerConsumer(2));
  }
}

class AssemblerFactory extends EntityFactory {
  createEntity(x: number, y: number): Entity {
    return new Entity()
      .addComponent(new Position(x, y))
      .addComponent(new Renderable('rect', 'gray'))
      .addComponent(new Inventory(new Map(), 10))
      .addComponent(new Recipe([], [], 0))
      .addComponent(new PowerConsumer(5));
  }
}
```

#### å‚è€ƒè¨˜äº‹
- [Factory Method - Refactoring Guru](https://refactoring.guru/design-patterns/factory-method) ï¼ˆè‹±èªï¼‰
- [TypeScriptã§ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç†è§£ã™ã‚‹](https://fireship.io/lessons/typescript-design-patterns/) ï¼ˆè‹±èªï¼‰

### 5. Command Pattern â–³é™å®šçš„é©ç”¨

#### è©³ç´°èª¬æ˜

ã‚³ãƒãƒ³ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆå‘½ä»¤ï¼‰ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ã‚«ãƒ—ã‚»ãƒ«åŒ–ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ç•°ãªã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ã€ãƒ­ã‚°è¨˜éŒ²ã€å…ƒã«æˆ»ã™ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹è¡Œå‹•ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã‚ã‚‹ã€‚ã‚²ãƒ¼ãƒ é–‹ç™ºã§ã¯ç‰¹ã«ã€ã‚¢ãƒ³ãƒ‰ã‚¥ãƒ»ãƒªãƒ‰ã‚¥æ©Ÿèƒ½ã‚„ãƒªãƒ—ãƒ¬ã‚¤ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…ã«æœ‰ç”¨ã§ã‚ã‚‹ã€‚

#### Factorioã‚¯ãƒ­ãƒ¼ãƒ³ã§ã®é©ç”¨

**ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†**:
```typescript
interface Command {
  execute(): void;
  undo(): void;
}

class PlaceEntityCommand implements Command {
  constructor(
    private world: World,
    private entityType: string,
    private x: number,
    private y: number
  ) {}

  execute() {
    this.world.placeEntity(this.entityType, this.x, this.y);
  }

  undo() {
    this.world.removeEntity(this.x, this.y);
  }
}

class RemoveEntityCommand implements Command {
  private removedEntity: Entity | null = null;

  constructor(private world: World, private x: number, private y: number) {}

  execute() {
    this.removedEntity = this.world.removeEntity(this.x, this.y);
  }

  undo() {
    if (this.removedEntity) {
      this.world.placeEntity(this.removedEntity, this.x, this.y);
    }
  }
}
```

#### å‚è€ƒè¨˜äº‹
- [Command - Game Programming Patterns](https://gameprogrammingpatterns.com/command.html) ï¼ˆè‹±èªï¼‰
- [Decoupling your game code via Command pattern](https://medium.com/gamedev-architecture/decoupling-game-code-via-command-pattern-debugging-it-with-time-machine-2b177e61556c) ï¼ˆè‹±èªï¼‰

## æ¨å¥¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ§‹æˆ

### ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: ECS + State + Observer

```typescript
interface GameArchitecture {
  world: World;                    // ECS World
  systems: System[];               // ECS Systems
  stateManager: StateManager;      // State Pattern
  eventBus: EventBus;             // Observer Pattern
  entityFactories: Map<string, EntityFactory>; // Factory Pattern
}

class FactorioClone {
  private world = new World();
  private systems = [
    new MovementSystem(),
    new CraftingSystem(),
    new PowerSystem(),
    new TransportSystem(),
    new RenderSystem()
  ];
  private stateManager = new GameStateManager();
  private eventBus = new EventBus();
  private entityFactories = new Map<string, EntityFactory>();

  constructor() {
    this.initializeFactories();
    this.setupEventListeners();
  }

  private initializeFactories() {
    this.entityFactories.set('belt', new BeltFactory());
    this.entityFactories.set('inserter', new InserterFactory());
    this.entityFactories.set('assembler', new AssemblerFactory());
  }

  private setupEventListeners() {
    this.eventBus.on('power-changed', (supply, demand) => {
      this.systems.forEach(system => {
        if (system instanceof PowerSystem) {
          system.handlePowerChange(supply, demand);
        }
      });
    });
  }

  update(deltaTime: number) {
    this.systems.forEach(system => system.update(deltaTime));
    this.stateManager.update();
  }
}
```

## æ®µéšçš„å°å…¥ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

### Phase 1: ã‚·ãƒ³ãƒ—ãƒ«é–‹å§‹
- åŸºæœ¬çš„ãªã‚¯ãƒ©ã‚¹è¨­è¨ˆã§ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ä½œæˆ
- Observer Patternã§EventBusã‚’å®Ÿè£…ã—ã€æœ€ä½é™ã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†

### Phase 2: ECSå°å…¥
- ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è¤‡é›‘åŒ–ã«ä¼´ã„ECSå°å…¥
- State Patternã§æ©Ÿæ¢°ã®çŠ¶æ…‹ç®¡ç†è¿½åŠ 

### Phase 3: å®Œå…¨ãªãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨
- å…¨ã‚·ã‚¹ãƒ†ãƒ ã®çµ±åˆã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- Factory Patternã§ã‚³ãƒ¼ãƒ‰ã®æ•´ç†
- Command Patternã§é«˜åº¦ãªæ©Ÿèƒ½è¿½åŠ ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

## åˆ©ç‚¹ã¨ãƒªã‚¹ã‚¯

### åˆ©ç‚¹
- **ECS**: ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æŸ”è»Ÿãªçµ„ã¿åˆã‚ã›ã¨é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- **State Pattern**: è¤‡é›‘ãªæ©Ÿæ¢°ã®çŠ¶æ…‹ç®¡ç†ã®æ˜ç¢ºåŒ–
- **Observer Pattern**: ã‚·ã‚¹ãƒ†ãƒ é–“ã®ç–çµåˆãªé€šä¿¡
- **Factory Pattern**: çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§å‘ä¸Š

### ãƒªã‚¹ã‚¯ãƒ»æ³¨æ„ç‚¹
- **ECSå­¦ç¿’ã‚³ã‚¹ãƒˆ**: å¾“æ¥ã®OOPã¨ç•°ãªã‚‹æ€è€ƒãŒå¿…è¦
- **éåº¦ãªè¨­è¨ˆ**: ã‚·ãƒ³ãƒ—ãƒ«ãªéƒ¨åˆ†ã«ã¯é©ç”¨ã›ãšã€å¿…è¦ãªç®‡æ‰€ã®ã¿ä½¿ç”¨
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: é©åˆ‡ãªå®Ÿè£…ãŒé‡è¦ï¼ˆç‰¹ã«ECSã®ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆï¼‰
- **ãƒ‡ãƒãƒƒã‚°ã®è¤‡é›‘æ€§**: è¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒç›¸äº’ä½œç”¨ã™ã‚‹å ´åˆã®è¿½è·¡ãŒå›°é›£

## çµè«–

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€**ECS + State + Observer**ã‚’æ ¸ã¨ã—ãŸæ®µéšçš„ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å°å…¥ã‚’æ¨å¥¨ã™ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Factorioã®è¤‡é›‘ãªã‚·ã‚¹ãƒ†ãƒ é–“ç›¸äº’ä½œç”¨ã‚’åŠ¹ç‡çš„ã«ç®¡ç†ã—ã€TypeScriptã®å‹å®‰å…¨æ€§ã‚’æ´»ã‹ã—ãŸä¿å®ˆæ€§ã®é«˜ã„å®Ÿè£…ãŒå¯èƒ½ã«ãªã‚‹ã€‚